#!/bin/bash

# A pip3 wrapper which makes scripts portable by setting their shebang to "/bin/env python3".
# It does so by setting argv[0] of the Python interpreter to "/bin/env python3".

# Define variables
env="$(realpath "$(dirname "$0")/..")"
site_packages="$env/lib/python3/site-packages"

# Set the PIP_TARGET as we cannot use the context of our environment when setting argv[0]
export PIP_TARGET="$site_packages"

# Instead of directly calling pip3, define a set of python commands
# as a workaround to set sys.executable to "/bin/env python3"
# and setting sys.argv[0] back to $0
custom_pip='from pip._internal.cli.main import main, sys; sys.executable="/usr/bin/env python3"; sys.argv[0]="'"$0"'"; sys.exit(main())'

# Exec python3 with the custom set of commands
exec "$env/bin/python" -c "$custom_pip" "$@"
